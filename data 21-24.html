<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Operasional Pabrik Kelapa Sawit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        /* Variabel Warna Inspirasi Kelapa Sawit */
        :root {
            --color-palm-green: #38761D; /* Hijau Utama */
            --color-light-green: #6AA84F; /* Hijau Aksen */
            --color-dark-green: #1C4504; /* Hijau Gelap */
            --color-background: #F8F9FA;
            --color-card-bg: #FFFFFF;
            --color-text-dark: #333;
            --color-border: #E0E0E0;
        }

        /* Gaya Dasar */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header dan Kontrol */
        header {
            background-color: var(--color-palm-green);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }
        
        header i {
            margin-right: 10px;
        }

        .controls button, .controls label {
            background-color: var(--color-light-green);
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        .controls button:hover, .controls label:hover {
            background-color: var(--color-dark-green);
        }
        
        #file-upload-input {
            display: none;
        }

        /* Kartu KPI */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .kpi-card {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kpi-card i {
            font-size: 2em;
            color: var(--color-palm-green);
        }

        .kpi-value {
            text-align: right;
        }

        .kpi-value h3 {
            margin: 0;
            font-size: 1.5em;
            color: var(--color-dark-green);
        }

        .kpi-value p {
            margin: 0;
            font-size: 0.9em;
            color: #666;
        }

        /* Area Grafik */
        .chart-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr; /* Bar dan Line lebih besar dari Pie */
            gap: 20px;
            margin-top: 30px;
        }

        .chart-card {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        /* Tabel Data */
        .data-table-section {
            margin-top: 30px;
        }

        .data-table-section h2 {
            border-bottom: 2px solid var(--color-palm-green);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .table-controls input, .table-controls select {
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }
        
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        #data-table th, #data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        #data-table th {
            background-color: var(--color-light-green);
            color: white;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #data-table tr:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-seedling"></i> Dasbor Operasional Pabrik Kelapa Sawit</h1>
        <div class="controls">
            <label for="file-upload-input" title="Unggah file CSV">
                <i class="fas fa-upload"></i> Unggah Data CSV
            </label>
            <input type="file" id="file-upload-input" accept=".csv">
            <button id="download-data-btn" disabled title="Unduh data yang saat ini difilter">
                <i class="fas fa-download"></i> Unduh Data
            </button>
        </div>
    </header>

    <main class="container">
        
        <h2><i class="fas fa-tachometer-alt"></i> Ringkasan Kinerja Utama</h2>
        <div class="kpi-grid">
            <div class="kpi-card">
                <i class="fas fa-box"></i>
                <div class="kpi-value">
                    <h3 id="kpi-produksi">0</h3>
                    <p>Total Produksi (Ton)</p>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fas fa-money-bill-wave"></i>
                <div class="kpi-value">
                    <h3 id="kpi-harga">IDR 0</h3>
                    <p>Rata-rata Harga Jual</p>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fas fa-map-marked-alt"></i>
                <div class="kpi-value">
                    <h3 id="kpi-area">0</h3>
                    <p>Total Area (Ha)</p>
                </div>
            </div>
            <div class="kpi-card">
                <i class="fas fa-chart-line"></i>
                <div class="kpi-value">
                    <h3 id="kpi-margin">0%</h3>
                    <p>Margin Efisiensi</p>
                </div>
            </div>
        </div>

        <hr style="margin: 30px 0; border-color: var(--color-border);">

        <h2><i class="fas fa-chart-bar"></i> Visualisasi Data Interaktif</h2>
        <div class="chart-grid">
            <div class="chart-card" style="grid-column: span 1;">
                <h3>Produksi Tahunan (Ton)</h3>
                <canvas id="bar-chart"></canvas>
            </div>
            
            <div class="chart-card" style="grid-column: span 1;">
                <h3>Tren Harga Jual (IDR)</h3>
                <canvas id="line-chart"></canvas>
            </div>
            
             <div class="chart-card" style="grid-column: span 2; max-width: 400px; margin: 0 auto;">
                <h3>Proporsi Area Berdasarkan Jenis</h3>
                <canvas id="pie-chart"></canvas>
            </div>
        </div>
        
        <hr style="margin: 30px 0; border-color: var(--color-border);">

        <div class="data-table-section">
            <h2><i class="fas fa-table"></i> Data Mentah Detail</h2>
            
            <div class="table-controls">
                <input type="text" id="search-input" placeholder="Cari di tabel..." onkeyup="filterTable()">
                <select id="filter-select" onchange="filterTable()">
                    <option value="">Semua Lokasi</option>
                    </select>
            </div>
            
            <div class="data-table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <tr><td colspan="5" style="text-align: center;">Unggah file CSV untuk menampilkan data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- VARIABEL GLOBAL ---
        let allData = []; // Data mentah dari CSV
        let filteredData = []; // Data yang saat ini ditampilkan/difilter
        let currentSortColumn = null;
        let currentSortDirection = 1; // 1 = ascending, -1 = descending
        
        let barChartInstance, lineChartInstance, pieChartInstance;
        
        // Warna untuk Chart.js (Nuansa Hijau)
        const PALM_COLORS = [
            'rgba(56, 118, 29, 0.8)', // palm-green
            'rgba(106, 168, 79, 0.8)', // light-green
            'rgba(28, 69, 4, 0.8)', // dark-green
            'rgba(142, 180, 21, 0.8)',
            'rgba(179, 217, 127, 0.8)'
        ];
        
        // --- FUNGSI UTAMA ---

        // 1. Pemuat File dan Papa Parse
        document.getElementById('file-upload-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Asumsi Kolom: Tanggal, Lokasi, Produksi_Ton, Area_Ha, Harga_IDR_Kg, Jenis_Sawit
                        allData = results.data;
                        filteredData = [...allData]; // Salin data awal
                        
                        updateDashboard(filteredData);
                        document.getElementById('download-data-btn').disabled = false;
                    }
                });
            }
        });

        // 2. Perbarui Semua Komponen Dasbor
        function updateDashboard(data) {
            if (data.length === 0) return;
            
            // Perbarui KPI
            updateKPI(data);
            
            // Perbarui Tabel & Filter
            renderTable(data);
            populateFilters(allData); // Gunakan allData untuk mengisi opsi filter
            
            // Perbarui Grafik
            renderCharts(data);
            
            // Reset sort
            currentSortColumn = null;
            currentSortDirection = 1;
        }

        // 3. Perbarui KPI
        function updateKPI(data) {
            if (data.length === 0) {
                document.getElementById('kpi-produksi').innerText = '0';
                document.getElementById('kpi-harga').innerText = 'IDR 0';
                document.getElementById('kpi-area').innerText = '0';
                document.getElementById('kpi-margin').innerText = '0%';
                return;
            }

            const totalProduksi = data.reduce((sum, row) => sum + (parseFloat(row.Produksi_Ton) || 0), 0);
            const totalArea = data.reduce((sum, row) => sum + (parseFloat(row.Area_Ha) || 0), 0);
            const totalHarga = data.reduce((sum, row) => sum + (parseFloat(row.Harga_IDR_Kg) || 0), 0);
            const avgHarga = totalHarga / data.length;
            
            // Contoh perhitungan fiktif
            const margin = (totalProduksi > 0) ? (totalArea / totalProduksi * 10).toFixed(2) : 0; 

            document.getElementById('kpi-produksi').innerText = (totalProduksi / 1000).toFixed(2) + 'K';
            document.getElementById('kpi-harga').innerText = 'IDR ' + new Intl.NumberFormat('id-ID').format(Math.round(avgHarga));
            document.getElementById('kpi-area').innerText = totalArea.toFixed(2);
            document.getElementById('kpi-margin').innerText = margin + '%';
        }
        
        // 4. Inisialisasi/Perbarui Grafik
        function renderCharts(data) {
            // Data Grafik Batang (Produksi Tahunan - Contoh Sederhana)
            const prodData = data.reduce((acc, row) => {
                const year = row.Tanggal ? new Date(row.Tanggal).getFullYear() : 'Tidak Diketahui';
                acc[year] = (acc[year] || 0) + (parseFloat(row.Produksi_Ton) || 0);
                return acc;
            }, {});
            const barLabels = Object.keys(prodData).sort();
            const barValues = barLabels.map(label => prodData[label]);

            // Data Grafik Garis (Tren Harga)
            const lineData = data.slice().sort((a, b) => new Date(a.Tanggal) - new Date(b.Tanggal));
            const lineLabels = lineData.map(row => row.Tanggal);
            const lineValues = lineData.map(row => parseFloat(row.Harga_IDR_Kg) || 0);
            
            // Data Diagram Lingkaran (Proporsi Jenis Sawit)
            const pieData = data.reduce((acc, row) => {
                const jenis = row.Jenis_Sawit || 'Lainnya';
                acc[jenis] = (acc[jenis] || 0) + (parseFloat(row.Area_Ha) || 0);
                return acc;
            }, {});
            const pieLabels = Object.keys(pieData);
            const pieValues = pieLabels.map(label => pieData[label]);

            // Inisialisasi atau Hancurkan & Buat Ulang Grafik
            if (barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(document.getElementById('bar-chart'), {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'Total Produksi (Ton)',
                        data: barValues,
                        backgroundColor: PALM_COLORS[0],
                        borderColor: PALM_COLORS[2],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
            });
            
            if (lineChartInstance) lineChartInstance.destroy();
            lineChartInstance = new Chart(document.getElementById('line-chart'), {
                type: 'line',
                data: {
                    labels: lineLabels,
                    datasets: [{
                        label: 'Harga (IDR/Kg)',
                        data: lineValues,
                        borderColor: PALM_COLORS[1],
                        tension: 0.1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
            });
            
            if (pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(document.getElementById('pie-chart'), {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieValues,
                        backgroundColor: PALM_COLORS
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }
        
        // 5. Render Tabel
        function renderTable(data) {
            const tableBody = document.getElementById('data-table-body');
            const tableHeadRow = document.querySelector('#data-table thead tr');
            tableBody.innerHTML = '';
            tableHeadRow.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data yang tersedia atau sesuai dengan filter.</td></tr>';
                return;
            }
            
            // Buat Header Tabel
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.innerText = header.replace(/_/g, ' ');
                th.setAttribute('onclick', `sortTable('${header}')`);
                tableHeadRow.appendChild(th);
            });
            
            // Isi Body Tabel
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.innerText = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // 6. Isi Opsi Filter
        function populateFilters(data) {
            const select = document.getElementById('filter-select');
            select.innerHTML = '<option value="">Semua Lokasi</option>';
            
            const locations = new Set(data.map(row => row.Lokasi).filter(Boolean));
            
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.innerText = loc;
                select.appendChild(option);
            });
        }
        
        // 7. Filter Tabel dan Data (Dipicu oleh input/select)
        function filterTable() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const filterSelect = document.getElementById('filter-select').value;
            
            filteredData = allData.filter(row => {
                // Filter Pencarian Global
                const matchesSearch = Object.values(row).some(val => 
                    String(val).toLowerCase().includes(searchInput)
                );
                
                // Filter Lokasi
                const matchesLocation = !filterSelect || row.Lokasi === filterSelect;
                
                return matchesSearch && matchesLocation;
            });
            
            updateDashboard(filteredData); // Perbarui KPI, Grafik, dan Tabel dengan data yang difilter
        }

        // 8. Sorting Tabel
        function sortTable(columnName) {
            if (currentSortColumn !== columnName) {
                currentSortColumn = columnName;
                currentSortDirection = 1;
            } else {
                currentSortDirection *= -1; // Balikkan arah sort
            }

            filteredData.sort((a, b) => {
                const valA = isNaN(parseFloat(a[columnName])) ? String(a[columnName]) : parseFloat(a[columnName]);
                const valB = isNaN(parseFloat(b[columnName])) ? String(b[columnName]) : parseFloat(b[columnName]);

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return (valA - valB) * currentSortDirection;
                } else {
                    return String(valA).localeCompare(String(valB)) * currentSortDirection;
                }
            });

            renderTable(filteredData);
        }

        // 9. Unduh Data (CSV)
        document.getElementById('download-data-btn').addEventListener('click', function() {
            if (filteredData.length === 0) return;

            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'data_kelapa_sawit_export.csv');
            link.click();
        });
        
        // --- DATA CONTOH (Simulasi Data Unggahan) ---
        const sampleCSV = `Tanggal,Lokasi,Produksi_Ton,Area_Ha,Harga_IDR_Kg,Jenis_Sawit
        2025-01-01,Pabrik A,150,10,12500,Tenera
        2025-01-05,Pabrik B,210,15,13000,Dura
        2025-01-10,Pabrik A,180,12,12800,Tenera
        2025-02-01,Pabrik C,300,20,13500,Dura
        2025-02-05,Pabrik B,250,18,13200,Tenera
        2025-03-01,Pabrik A,190,11,12600,Tenera
        2025-03-05,Pabrik C,280,22,13800,Dura
        2025-04-01,Pabrik B,230,16,13100,Tenera`;

        // Pemuatan data contoh saat startup
        Papa.parse(sampleCSV, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allData = results.data;
                filteredData = [...allData];
                updateDashboard(filteredData);
                document.getElementById('download-data-btn').disabled = false;
            }
        });
        
    </script>
</body>
</html>